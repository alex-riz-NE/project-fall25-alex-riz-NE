import*as x from"net";import*as b from"tls";import*as v from"../debug@4.4.3/index.js";import*as O from"events";import*as P from"../agent-base@7.1.4/index.js";import*as w from"url";var s=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function i(e){return e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var d={},H=i(x),j=i(b),R=i(v),D=i(O),A=i(P),C=i(w),$=s&&s.__createBinding||(Object.create?function(e,t,r,o){o===void 0&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);(!n||("get"in n?!t.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){o===void 0&&(o=r),e[o]=t[r]}),q=s&&s.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),h=s&&s.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)r!=="default"&&Object.prototype.hasOwnProperty.call(e,r)&&$(t,e,r);return q(t,e),t},S=s&&s.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(d,"__esModule",{value:!0});var y=d.HttpProxyAgent=void 0;const M=h(H),k=h(j),B=S(R),I=D,T=A,g=C,p=(0,B.default)("http-proxy-agent");class m extends T.Agent{constructor(t,r){super(r),this.proxy=typeof t=="string"?new g.URL(t):t,this.proxyHeaders=r?.headers??{},p("Creating new HttpProxyAgent instance: %o",this.proxy.href);const o=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),n=this.proxy.port?parseInt(this.proxy.port,10):this.proxy.protocol==="https:"?443:80;this.connectOpts={...r?U(r,"headers"):null,host:o,port:n}}addRequest(t,r){t._header=null,this.setRequestProps(t,r),super.addRequest(t,r)}setRequestProps(t,r){const{proxy:o}=this,n=r.secureEndpoint?"https:":"http:",a=t.getHeader("host")||"localhost",_=`${n}//${a}`,l=new g.URL(t.path,_);r.port!==80&&(l.port=String(r.port)),t.path=String(l);const u=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders};if(o.username||o.password){const c=`${decodeURIComponent(o.username)}:${decodeURIComponent(o.password)}`;u["Proxy-Authorization"]=`Basic ${Buffer.from(c).toString("base64")}`}u["Proxy-Connection"]||(u["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(const c of Object.keys(u)){const f=u[c];f&&t.setHeader(c,f)}}async connect(t,r){t._header=null,t.path.includes("://")||this.setRequestProps(t,r);let o,n;p("Regenerating stored HTTP header string for request"),t._implicitHeader(),t.outputData&&t.outputData.length>0&&(p("Patching connection write() output buffer with updated header"),o=t.outputData[0].data,n=o.indexOf(`\r
\r
`)+4,t.outputData[0].data=t._header+o.substring(n),p("Output buffer: %o",t.outputData[0].data));let a;return this.proxy.protocol==="https:"?(p("Creating `tls.Socket`: %o",this.connectOpts),a=k.connect(this.connectOpts)):(p("Creating `net.Socket`: %o",this.connectOpts),a=M.connect(this.connectOpts)),await(0,I.once)(a,"connect"),a}}m.protocols=["http","https"],y=d.HttpProxyAgent=m;function U(e,...t){const r={};let o;for(o in e)t.includes(o)||(r[o]=e[o]);return r}export{y as HttpProxyAgent,d as default};
