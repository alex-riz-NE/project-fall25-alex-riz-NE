import*as D from"net";import*as B from"tls";import*as U from"assert";import*as q from"../debug@4.4.3/index.js";import*as G from"../agent-base@7.1.4/index.js";import*as z from"url";var c=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function f(e){return e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var g={},F=f(D),K=f(B),J=f(U),j=f(q),Q=f(G),V=f(z),b={},W=c&&c.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(b,"__esModule",{value:!0}),b.parseProxyResponse=void 0;const X=W(j),_=(0,X.default)("https-proxy-agent:parse-proxy-response");function Y(e){return new Promise((o,t)=>{let r=0;const n=[];function s(){const a=e.read();a?l(a):e.once("readable",s)}function p(){e.removeListener("end",d),e.removeListener("error",v),e.removeListener("readable",s)}function d(){p(),_("onend"),t(new Error("Proxy connection ended before receiving CONNECT response"))}function v(a){p(),_("onerror %o",a),t(a)}function l(a){n.push(a),r+=a.length;const u=Buffer.concat(n,r),i=u.indexOf(`\r
\r
`);if(i===-1){_("have not received end of HTTP headers yet..."),s();return}const T=u.slice(0,i).toString("ascii").split(`\r
`),O=T.shift();if(!O)return e.destroy(),t(new Error("No header received from proxy CONNECT response"));const N=O.split(" "),M=+N[1],S=N.slice(2).join(" "),h={};for(const y of T){if(!y)continue;const w=y.indexOf(":");if(w===-1)return e.destroy(),t(new Error(`Invalid header from proxy CONNECT response: "${y}"`));const C=y.slice(0,w).toLowerCase(),$=y.slice(w+1).trimStart(),x=h[C];typeof x=="string"?h[C]=[x,$]:Array.isArray(x)?x.push($):h[C]=$}_("got proxy server response: %o %o",O,h),p(),o({connect:{statusCode:M,statusText:S,headers:h},buffered:u})}e.on("error",v),e.on("end",d),s()})}b.parseProxyResponse=Y;var Z=c&&c.__createBinding||(Object.create?function(e,o,t,r){r===void 0&&(r=t);var n=Object.getOwnPropertyDescriptor(o,t);(!n||("get"in n?!o.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,r,n)}:function(e,o,t,r){r===void 0&&(r=t),e[r]=o[t]}),ee=c&&c.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),H=c&&c.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(e!=null)for(var t in e)t!=="default"&&Object.prototype.hasOwnProperty.call(e,t)&&Z(o,e,t);return ee(o,e),o},A=c&&c.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(g,"__esModule",{value:!0});var E=g.HttpsProxyAgent=void 0;const P=H(F),k=H(K),te=A(J),oe=A(j),re=Q,ne=V,se=b,m=(0,oe.default)("https-proxy-agent"),R=e=>e.servername===void 0&&e.host&&!P.isIP(e.host)?{...e,servername:e.host}:e;class I extends re.Agent{constructor(o,t){super(t),this.options={path:void 0},this.proxy=typeof o=="string"?new ne.URL(o):o,this.proxyHeaders=t?.headers??{},m("Creating new HttpsProxyAgent instance: %o",this.proxy.href);const r=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),n=this.proxy.port?parseInt(this.proxy.port,10):this.proxy.protocol==="https:"?443:80;this.connectOpts={ALPNProtocols:["http/1.1"],...t?L(t,"headers"):null,host:r,port:n}}async connect(o,t){const{proxy:r}=this;if(!t.host)throw new TypeError('No "host" provided');let n;r.protocol==="https:"?(m("Creating `tls.Socket`: %o",this.connectOpts),n=k.connect(R(this.connectOpts))):(m("Creating `net.Socket`: %o",this.connectOpts),n=P.connect(this.connectOpts));const s=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders},p=P.isIPv6(t.host)?`[${t.host}]`:t.host;let d=`CONNECT ${p}:${t.port} HTTP/1.1\r
`;if(r.username||r.password){const i=`${decodeURIComponent(r.username)}:${decodeURIComponent(r.password)}`;s["Proxy-Authorization"]=`Basic ${Buffer.from(i).toString("base64")}`}s.Host=`${p}:${t.port}`,s["Proxy-Connection"]||(s["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(const i of Object.keys(s))d+=`${i}: ${s[i]}\r
`;const v=(0,se.parseProxyResponse)(n);n.write(`${d}\r
`);const{connect:l,buffered:a}=await v;if(o.emit("proxyConnect",l),this.emit("proxyConnect",l,o),l.statusCode===200)return o.once("socket",ie),t.secureEndpoint?(m("Upgrading socket connection to TLS"),k.connect({...L(R(t),"host","path","port"),socket:n})):n;n.destroy();const u=new P.Socket({writable:!1});return u.readable=!0,o.once("socket",i=>{m("Replaying proxy buffer for failed request"),(0,te.default)(i.listenerCount("data")>0),i.push(a),i.push(null)}),u}}I.protocols=["http","https"],E=g.HttpsProxyAgent=I;function ie(e){e.resume()}function L(e,...o){const t={};let r;for(r in e)o.includes(r)||(t[r]=e[r]);return t}export{E as HttpsProxyAgent,g as default};
