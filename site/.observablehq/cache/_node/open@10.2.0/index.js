import x from"node:process";import{Buffer as v}from"node:buffer";import b from"node:path";import{fileURLToPath as S}from"node:url";import{promisify as C}from"node:util";import y from"node:child_process";import M,{constants as T}from"node:fs/promises";import{isWsl as w,powerShellPath as A}from"../wsl-utils@0.1.0/index.js";import p from"../define-lazy-prop@3.0.0/index.js";import z from"../default-browser@5.4.0/index.js";import N from"../is-inside-container@1.0.0/index.js";const $=C(y.execFile),u=b.dirname(S(import.meta.url)),P=b.join(u,"xdg-open"),{platform:f,arch:E}=x;async function k(){const r=await A(),e=String.raw`(Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\Shell\Associations\UrlAssociations\http\UserChoice").ProgId`,o=v.from(e,"utf16le").toString("base64"),{stdout:a}=await $(r,["-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand",o],{encoding:"utf8"}),i=a.trim(),m={ChromeHTML:"com.google.chrome",BraveHTML:"com.brave.Browser",MSEdgeHTM:"com.microsoft.edge",FirefoxURL:"org.mozilla.firefox"};return m[i]?{id:m[i]}:{}}const B=async(r,e)=>{let o;for(const a of r)try{return await e(a)}catch(i){o=i}throw o},g=async r=>{if(r={wait:!1,background:!1,newInstance:!1,allowNonzeroExitCode:!1,...r},Array.isArray(r.app))return B(r.app,t=>g({...r,app:t}));let{name:e,arguments:o=[]}=r.app??{};if(o=[...o],Array.isArray(e))return B(e,t=>g({...r,app:{name:t,arguments:o}}));if(e==="browser"||e==="browserPrivate"){const t={"com.google.chrome":"chrome","google-chrome.desktop":"chrome","com.brave.Browser":"brave","org.mozilla.firefox":"firefox","firefox.desktop":"firefox","com.microsoft.msedge":"edge","com.microsoft.edge":"edge","com.microsoft.edgemac":"edge","microsoft-edge.desktop":"edge"},n={chrome:"--incognito",brave:"--incognito",firefox:"--private-window",edge:"--inPrivate"},c=w?await k():await z();if(c.id in t){const h=t[c.id];return e==="browserPrivate"&&o.push(n[h]),g({...r,app:{name:s[h],arguments:o}})}throw new Error(`${c.name} is not supported as a default browser`)}let a;const i=[],m={};if(f==="darwin")a="open",r.wait&&i.push("--wait-apps"),r.background&&i.push("--background"),r.newInstance&&i.push("--new"),e&&i.push("-a",e);else if(f==="win32"||w&&!N()&&!e){a=await A(),i.push("-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand"),w||(m.windowsVerbatimArguments=!0);const t=["Start"];r.wait&&t.push("-Wait"),e?(t.push(`"\`"${e}\`""`),r.target&&o.push(r.target)):r.target&&t.push(`"${r.target}"`),o.length>0&&(o=o.map(n=>`"\`"${n}\`""`),t.push("-ArgumentList",o.join(","))),r.target=v.from(t.join(" "),"utf16le").toString("base64")}else{if(e)a=e;else{const t=!u||u==="/";let n=!1;try{await M.access(P,T.X_OK),n=!0}catch{}a=x.versions.electron??(f==="android"||t||!n)?"xdg-open":P}o.length>0&&i.push(...o),r.wait||(m.stdio="ignore",m.detached=!0)}f==="darwin"&&o.length>0&&i.push("--args",...o),r.target&&i.push(r.target);const l=y.spawn(a,i,m);return r.wait?new Promise((t,n)=>{l.once("error",n),l.once("close",c=>{if(!r.allowNonzeroExitCode&&c>0){n(new Error(`Exited with code ${c}`));return}t(l)})}):(l.unref(),l)},I=(r,e)=>{if(typeof r!="string")throw new TypeError("Expected a `target`");return g({...e,target:r})},L=(r,e)=>{if(typeof r!="string"&&!Array.isArray(r))throw new TypeError("Expected a valid `name`");const{arguments:o=[]}=e??{};if(o!=null&&!Array.isArray(o))throw new TypeError("Expected `appArguments` as Array type");return g({...e,app:{name:r,arguments:o}})};function F(r){if(typeof r=="string"||Array.isArray(r))return r;const{[E]:e}=r;if(!e)throw new Error(`${E} is not supported`);return e}function d({[f]:r},{wsl:e}){if(e&&w)return F(e);if(!r)throw new Error(`${f} is not supported`);return F(r)}const s={};p(s,"chrome",()=>d({darwin:"google chrome",win32:"chrome",linux:["google-chrome","google-chrome-stable","chromium"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe",x64:["/mnt/c/Program Files/Google/Chrome/Application/chrome.exe","/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe"]}})),p(s,"brave",()=>d({darwin:"brave browser",win32:"brave",linux:["brave-browser","brave"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe",x64:["/mnt/c/Program Files/BraveSoftware/Brave-Browser/Application/brave.exe","/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe"]}})),p(s,"firefox",()=>d({darwin:"firefox",win32:String.raw`C:\Program Files\Mozilla Firefox\firefox.exe`,linux:"firefox"},{wsl:"/mnt/c/Program Files/Mozilla Firefox/firefox.exe"})),p(s,"edge",()=>d({darwin:"microsoft edge",win32:"msedge",linux:["microsoft-edge","microsoft-edge-dev"]},{wsl:"/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe"})),p(s,"browser",()=>"browser"),p(s,"browserPrivate",()=>"browserPrivate");var U=I;export{s as apps,U as default,L as openApp};
